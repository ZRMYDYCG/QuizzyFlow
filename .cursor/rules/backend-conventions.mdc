---
globs: server/**/*.ts
description: Backend NestJS and API development conventions
---

# Backend Development Conventions (NestJS)

## Project Structure

### Module Organization
- Each feature has its own module directory in [server/src/](mdc:server/src)
- Module structure:
  - `*.module.ts` - Module definition
  - `*.controller.ts` - Route handlers
  - `*.service.ts` - Business logic
  - `schemas/` - Mongoose schemas
  - `dto/` - Data Transfer Objects

### Main Modules
1. **Question Module** ([server/src/question/](mdc:server/src/question)) - Questionnaire CRUD
2. **User Module** ([server/src/user/](mdc:server/src/user)) - User management
3. **Auth Module** ([server/src/auth/](mdc:server/src/auth)) - Authentication
4. **Answer Module** ([server/src/answer/](mdc:server/src/answer)) - Survey responses
5. **Stat Module** ([server/src/stat/](mdc:server/src/stat)) - Statistics

## NestJS Patterns

### Controller Pattern

```typescript
import { Controller, Get, Post, Patch, Delete, Body, Param, Query, Request } from '@nestjs/common'

@Controller('resource')
export class ResourceController {
  constructor(private readonly service: ResourceService) {}
  
  @Post()
  async create(@Request() req, @Body() createDto: CreateDto) {
    const { username } = req.user
    return await this.service.create(username, createDto)
  }
  
  @Get(':id')
  async findOne(@Param('id') id: string, @Request() req) {
    const { username } = req.user
    return await this.service.findOne(id, username)
  }
}
```

### Service Pattern

```typescript
import { Injectable } from '@nestjs/common'
import { InjectModel } from '@nestjs/mongoose'
import { Model } from 'mongoose'

@Injectable()
export class ResourceService {
  constructor(
    @InjectModel(Resource.name) private resourceModel: Model<Resource>
  ) {}
  
  async create(username: string, data: CreateDto) {
    // Business logic here
  }
}
```

### DTOs (Data Transfer Objects)

- Located in `dto/` directories
- Use class-validator decorators
- Use class-transformer for transformation

```typescript
import { IsString, IsNotEmpty, IsOptional } from 'class-validator'

export class CreateResourceDto {
  @IsString()
  @IsNotEmpty()
  title: string
  
  @IsString()
  @IsOptional()
  description?: string
}
```

## Database (MongoDB + Mongoose)

### Schema Definition

```typescript
import { Schema, Prop, SchemaFactory } from '@nestjs/mongoose'
import { Document } from 'mongoose'

@Schema({ timestamps: true })
export class Resource extends Document {
  @Prop({ required: true })
  title: string
  
  @Prop()
  description: string
  
  @Prop({ required: true })
  author: string
}

export const ResourceSchema = SchemaFactory.createForClass(Resource)
```

### Connection Configuration
- Connection string in [server/src/app.module.ts](mdc:server/src/app.module.ts)
- Uses environment variables: `MONGO_HOST`, `MONGO_PORT`, `MONGO_DATABASE`
- Format: `mongodb://${host}:${port}/${database}`

## Authentication & Authorization

### JWT Authentication
- JWT module in [server/src/auth/](mdc:server/src/auth)
- Token validation via AuthGuard
- User data extracted from request: `req.user`

### Password Security
- Use bcryptjs for password hashing
- Never store plain text passwords
- Hash before saving: `bcrypt.hash(password, saltRounds)`
- Compare for login: `bcrypt.compare(password, hashedPassword)`

### Auth Guard Usage

```typescript
import { UseGuards } from '@nestjs/common'
import { AuthGuard } from '@nestjs/passport'

@UseGuards(AuthGuard('jwt'))
@Controller('protected')
export class ProtectedController {
  // Protected routes
}
```

## API Design

### RESTful Conventions

| Method | Route | Purpose |
|--------|-------|---------|
| POST | `/api/resource` | Create |
| GET | `/api/resource` | List (with query params) |
| GET | `/api/resource/:id` | Get one |
| PATCH | `/api/resource/:id` | Update |
| DELETE | `/api/resource/:id` | Delete |

### Query Parameters
- `keyword` - Search term
- `page` - Page number (pagination)
- `pageSize` - Items per page
- `isStar` - Filter starred items
- `isDeleted` - Filter deleted items

### Response Format
- Success: `{ data: any, message?: string }`
- Error: Handled by exception filters in [server/src/http-exeption/](mdc:server/src/http-exeption)

### HTTP Status Codes
- 200 OK - Successful GET/PATCH
- 201 Created - Successful POST
- 204 No Content - Successful DELETE
- 400 Bad Request - Validation error
- 401 Unauthorized - Authentication required
- 403 Forbidden - Insufficient permissions
- 404 Not Found - Resource not found

Use `@HttpCode()` decorator when needed:
```typescript
@Delete()
@HttpCode(HttpStatus.OK)
async delete() {
  // Returns 200 instead of default 204
}
```

## Question Module Patterns

### Common Operations (from [server/src/question/question.controller.ts](mdc:server/src/question/question.controller.ts))

1. **Create** - `POST /api/question`
2. **List** - `GET /api/question` (supports pagination, search, filters)
3. **Get One** - `GET /api/question/:id`
4. **Update** - `PATCH /api/question/:id`
5. **Soft Delete** - `DELETE /api/question` (batch)
6. **Restore** - `PATCH /api/question/:id/restore`
7. **Permanent Delete** - `DELETE /api/question/:id/permanent`
8. **Duplicate** - `POST /api/question/duplicate/:id`
9. **Statistics** - `GET /api/question/statistics`

### Soft Delete Pattern
- Use `isDeleted` boolean field
- Soft delete: Set `isDeleted = true`
- Restore: Set `isDeleted = false`
- Permanent delete: Actually remove from database

## Error Handling

### Exception Filters
- Custom exception filter in [server/src/http-exeption/http-exception.filter.ts](mdc:server/src/http-exeption/http-exception.filter.ts)
- Apply globally or per controller
- Format errors consistently

### Throwing Exceptions
```typescript
import { NotFoundException, BadRequestException, UnauthorizedException } from '@nestjs/common'

throw new NotFoundException('Resource not found')
throw new BadRequestException('Invalid data')
throw new UnauthorizedException('Please login')
```

## Configuration

### Environment Variables
- Use `@nestjs/config` module
- Load via `ConfigModule.forRoot()` in app.module.ts
- Access via `process.env.VARIABLE_NAME`

### Development Scripts
- `pnpm start:dev` - Development with watch mode
- `pnpm build` - Production build
- `pnpm start:prod` - Run production build
- `pnpm test` - Run tests

## Testing

### Test Files
- Unit tests: `*.spec.ts` files
- E2E tests: `test/*.e2e-spec.ts`
- Jest configuration in [server/package.json](mdc:server/package.json)

### Test Commands
- `pnpm test` - Run all tests
- `pnpm test:watch` - Watch mode
- `pnpm test:cov` - With coverage
- `pnpm test:e2e` - E2E tests

## Dependencies

### Key Libraries
- `@nestjs/common` - Core NestJS
- `@nestjs/mongoose` - MongoDB integration
- `@nestjs/jwt` - JWT authentication
- `@nestjs/config` - Configuration management
- `bcryptjs` - Password hashing
- `class-validator` - Validation
- `class-transformer` - Transformation
- `nanoid` - ID generation
